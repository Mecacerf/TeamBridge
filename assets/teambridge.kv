#:kivy 2.3.0
#:import math math

#:set header_height_hint 0.15
#:set buttons_height_hint 0.35
#:set instruction_text_height_hint 0.25
#:set footer_height_hint 0.15
#:set top_space_height_hint 0.1

#:set progress_bar_y_hint 0.015

<IconButton>:
    size_hint: None, None
    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
    size: self.current_side, self.current_side

    canvas.before:
        Color:
            rgba: 0, 0, 0, 0.2
        RoundedRectangle:
            pos: self.size[0]*0.03, -self.size[0]*0.03
            size: self.size
            radius: [self.size[0]*0.22]
        Color:
            rgba: self.background_color
        RoundedRectangle:
            pos: 0, 0
            size: self.size
            radius: [self.size[0]*0.2]

    Image:
        size_hint: 0.6, 0.6
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        source: root.source
        fit_mode: 'contain'

<LinearProgressBar>:
    # Use canvas.after to cover legacy bar
    canvas.after:
        Color:
            rgba: app.theme.border_color
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: (app.theme.primary_color[0], app.theme.primary_color[1], app.theme.primary_color[2], self.bar_alpha)
        Rectangle:
            pos: (self.x, self.y)
            size: (self.width * (self.value / self.max) + self.width / 3.0 * math.sin(self.value / self.max * math.pi), self.height)
        Color:
            rgba: app.theme.border_color
        Rectangle:
            pos: (self.x, self.y)
            size: (self.width * (self.value / self.max) - self.width / 2.0 * math.sin(self.value / self.max * math.pi), self.height)

<SlidingBoxLayout>:
    size_hint: 1, 1
    pos_hint: self.current_pos

<IconLabel>:
    font_name: 'md-icons'
    color: app.theme.primary_color
    halign: 'center'
    valign: 'center'
    text_size: self.size
    font_size: self.height * 0.6

<MainScreen>:
    consultation_button: consultation_button_id
    clock_button: clock_button_id
    progress_bar: progress_bar_id
    sliding_box_layout: sliding_box_layout_id
    collapse_panel: collapse_panel_id

    # Main screen vertical box layout
    BoxLayout:
        size_hint: 1, 1
        pos_hint: {'x': 0, 'y': 0}
        orientation: 'vertical'

        # Set the background color for the main screen
        canvas.before:
            Color:
                rgba: app.theme.bg_color
            Rectangle:
                pos: self.pos
                size: self.size

        # Main screen header
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, header_height_hint

            # Left border
            Widget:
                size_hint_x: 0.05

            BoxLayout:
                orientation: 'vertical'
                size_hint: 1, 1

                # Top border
                Widget:
                    size_hint: 1, 0.2

                Label:
                    text: root.clock_time
                    halign: 'left'
                    valign: 'bottom'
                    text_size: self.size
                    font_size: self.parent.height * 0.4
                    color: app.theme.text_secondary_color
                    font_name: 'InterRegular'

                Label:
                    text: root.clock_date
                    halign: 'left'
                    valign: 'top'
                    text_size: self.size
                    font_size: self.parent.height * 0.2
                    color: app.theme.text_secondary_color
                    font_name: 'InterRegular'

            Widget:

            # Right justified logo
            Image:
                source: 'assets/logo_name.png'
                fit_mode: 'contain'
                size_hint_x: None
                width: self.texture_size[0] * (self.parent.height / self.texture_size[1]) 

        # Leave some space at the top to center the buttons     
        Widget:
            size_hint: 1, top_space_height_hint

        # Horizontal box layout for buttons
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, buttons_height_hint

            # Left border
            Widget:
                size_hint: 0.1, 1

            # Use 3 anchor layouts to center the square buttons
            AnchorLayout:
                size_hint: 0.26, 1
                
                ToggleIconButton:
                    id: consultation_button_id
                    source: 'assets/time.png'
                    on_press: if self.enabled: root.on_consultation_press()
        
            AnchorLayout:
                size_hint: 0.26, 1
                
                ToggleIconButton:
                    id: clock_button_id
                    source: 'assets/start_pause.png'
                    on_press: if self.enabled: root.on_clock_action_press()

            AnchorLayout:
                size_hint: 0.26, 1

                IconButton:
                    source: 'assets/group.png'
                    on_press: if self.enabled: root.on_attendance_press()

            # Right border
            Widget:
                size_hint: 0.1, 1

        Label:
            size_hint: 1, instruction_text_height_hint
            text: f"[b]{root.instruction_text}[/b]"
            markup: True
            color: root.instruction_text_color
            halign: 'center'
            valign: 'center'
            text_size: self.size
            font_size: self.height * 0.3
            font_name: 'InterMedium'

        Widget:
            size_hint: 1, footer_height_hint

    # The sliding box layout used to display pieces of information
    # is drawn above the main screen.
    SlidingBoxLayout:
        id: sliding_box_layout_id
        orientation: 'vertical'
        collapsed_pos: {'x': 0, 'y': -1.0 + footer_height_hint}
        expanded_pos: {'x': 0, 'y': -header_height_hint}
        duration: 0.6
        on_panel_press: root.on_info_panel_press()

        canvas.before:
            Color:
                rgba: app.theme.surface_color
            Rectangle:
                pos: self.pos
                size: self.size

        # Draw the progress bar 
        LinearProgressBar:
            id: progress_bar_id
            size_hint: 1, None
            height: self.parent.height * progress_bar_y_hint

        # This horizontal box layout holds the information panel title
        # that is always visible even when collapsed.
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, footer_height_hint - progress_bar_y_hint

            Widget:
                size_hint_x: 0.02

            BoxLayout:
                size_hint_x: 0.48
                orientation: 'vertical'

                Label:
                    text: root.greetings_text
                    color: app.theme.text_secondary_color
                    halign: 'left'
                    valign: 'bottom'
                    text_size: self.size
                    font_size: self.height * 0.6
                    font_name: 'InterRegular'

                Label:
                    text: root.information_text
                    color: app.theme.text_secondary_color
                    halign: 'left'
                    valign: 'top'
                    text_size: self.size
                    font_size: self.height * 0.6
                    font_name: 'InterRegular'

            Widget:
                size_hint_x: 0.4

            IconLabel:
                id: collapse_panel_id
                size_hint_x: 0.1
                icon_code: 'F0792'

        # Hold the current information panel
        BoxLayout:
            orientation: 'vertical'
            size_hint: 1, 1 - footer_height_hint - progress_bar_y_hint


